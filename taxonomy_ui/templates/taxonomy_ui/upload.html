{% extends "taxonomy_ui/base.html" %}
{% block content %}

<!-- ‚úÖ NO CSS OR JS CHANGED -->

<!-- ================= PAGE HEADER ================= -->
<div class="page-header">
  <div class="page-header-content">
    <h2>USER UPLOAD & PROCESSING</h2>
    <p>Upload your part file to automatically clean, map, and prepare it for download.</p>
    <p>We'll guide you step by step through the entire process.</p>
  </div>

  <button id="refresh-btn">
    <span>‚ü≥</span> Refresh Stage 1
  </button>
</div>

<div id="refresh-status"></div>

{% if error %}
<div style="color:#ef4444; margin-bottom:16px;">{{ error }}</div>
{% endif %}

<!-- ================= STEPPER ================= -->
<div class="stepper">
  <div class="step active">1. Upload <small>Select file</small></div>
  <div class="step {% if has_df %}active{% endif %}">2. Process <small>Auto mapping</small></div>
  <div class="step {% if has_df %}active{% endif %}">3. Download <small>Get output</small></div>
</div>

<div class="layout-grid">

<!-- ================= UPLOAD ================= -->
<div class="card upload-hero">
  <div class="card-header">üì§ Upload your file</div>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div id="upload-area" class="upload-box">
      <div class="upload-icon">üìÑ</div>
      <div class="upload-text">Drag & drop file here</div>
      <div class="upload-subtext">CSV, XLS, XLSX</div>
      <input type="file" name="files" multiple hidden id="file-input">
    </div>

    <div class="btn-row">
      <button class="btn-primary" type="submit">‚¨ÜÔ∏è Upload & Process</button>
      {% if download_link %}
      <a href="{{ download_link }}" class="btn-success">‚¨áÔ∏è Download All</a>
      {% endif %}
    </div>
  </form>
</div>

<!-- ================= COLUMN SELECT ================= -->
{% if has_df %}
<div class="card">
  <div class="card-header">üéØ Choose columns</div>

  <form method="post" action="{% url 'taxonomy_ui:download_selected_columns' %}">
    {% csrf_token %}

    <div class="columns-grid">
      <label class="column-chip">
        <input type="checkbox" onclick="toggleAll(this)"> Select all
      </label>

      {% for col in all_columns %}
      <label class="column-chip">
        ‚úÖ FIXED NAME
        <input type="checkbox" name="columns[]" value="{{ col }}">
        {{ col }}
      </label>
      {% endfor %}
    </div>

    <div class="btn-row">
      <button class="btn-success" type="submit">‚¨áÔ∏è Download Selected</button>
    </div>
  </form>
</div>
{% endif %}
</div>

<!-- ================= PREVIEW TABLE ================= -->
{% if has_df %}
<div class="card" style="margin-top:24px;">
  <div class="card-header">üëÅÔ∏è Processed Preview</div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          {% for col in preview_columns %}
          <th>{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in preview_rows %}
        <tr>
          {% for cell in row %}
          <td>{{ cell }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% endblock %}
